<html>

<head>
  <title>Leaflet test</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"
    integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ=="
    crossorigin=""></script>

  <style>
    html, body, textarea { width: 100%; height: 400px; padding: 0; margin: 0; }
    #map {
      height: 450px;
    }
    ul { padding: 0; }
    li { display: flex; }
    li span { width: 500px; word-break: break-all; }
    img { height: 20px; margin-left: 8px; cursor: pointer; }
    input { width: 150px; margin-right: 8px; }
    input[type='checkbox'] { width: auto; }
  </style>
</head>

<body>
  <div id="map"></div>

  <h1>Send message</h1>
  <ul></ul>
  <form id="send-message">
    <input id="input-message"></input>
    <input id="input-location"></input>
    
    <button>Add</button>
  </form>

  <div><button id="location-btn">Update location</button> <span id="my-location">Unknown</span></div>

  <h1>Messages</h1>
  <textarea id="messages" placeholder="Welcome to this geochat!"></textarea>

  <details>
    <summary><h1>Geopad</h1></summary>
    <textarea id="paste" placeholder="paste here!"></textarea>
  </details>

  <script src="https://cdn.jsdelivr.net/npm/gun/examples/jquery.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/webrtc.js"></script>


  <!-- gun - textarea-->
  <script>
    //gun = Gun(['http://localhost:8765/gun', 'https://gun-manhattan.herokuapp.com/gun']);

    // Don't rely on this node for demo https://gun-manhattan.herokuapp.com/stats.html
    gun = Gun('https://gun-manhattan.herokuapp.com/gun');
    copy = gun.get('test').get('paste');
    paste.oninput = () => { copy.put(paste.value) };
    copy.on((data) => { paste.value = data });

    messages = gun.get('messages')
  </script>

  
  <!-- leaflet stuff -->
  <script>
    var markers = {}
    var factory = [52.4940562, 13.4463269];
    var map = L.map('map').setView(factory, 15);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap & ETHBerlin'
    }).addTo(map);

    function onMapClick(e) {
      var message=window.prompt();
      data = {title: message, latitude: e.latlng.lat, longitude: e.latlng.lng}
      console.log(e.latlng)
      console.log(data)
      messages.set(data)
    }
    map.on('click', onMapClick);
  
    function addMarker(msg, id) {
      markers[id] = L.marker([msg.latitude, msg.longitude]).addTo(map);
      markers[id].bindPopup(msg.title).openPopup();
    }     

    function removeMarker(id) {
      if (markers[id] !== undefined) {
        markers[id].remove();
        delete markers[id];
      }
    }
  </script>

  <!-- gun messages-->
  <script>
    
    $('#send-message').on('submit', function (event) {
      var title = $('#input-message').val()
      var lat = $('#input-location').val().split(", ")[0]
      var lon = $('#input-location').val().split(", ")[1]
      data = {title: title, latitude: lat, longitude: lon}
      messages.set(data)
      event.preventDefault()
    })

    $('#location-btn').on('click', function (event) {
      console.log("Updating location (fake)")
      coords = "52.4940562, 13.4463269"
      $('#input-location').val(coords)
      $('#my-location').html(coords)
    })

    messages.map().on(function (msg, id) {
      var li = $('#' + id)
      if (!li.get(0)) {
        li = $('<li>').attr('id', id).appendTo('ul')
      }
      if (msg) {
        var html = '<span onclick="clickTitle(this)">' + msg.title + '(' + msg.latitude + ',' + msg.longitude + ')</span>'
        html = '<input type="checkbox" onclick="clickCheck(this)" ' + (msg.done ? 'checked' : '') + '>' + html
        html += '<img onclick="clickDelete(this)" src="https://cdnjs.cloudflare.com/ajax/libs/foundicons/3.0.0/svgs/fi-x.svg"/>'
        li.html(html)
        addMarker(msg, id)
        current = $('#messages').val()
        date = new Date();
        $('#messages').val(current + "\n" + "(" + date.toLocaleTimeString() + ") " + msg.title)
      } else {
        li.remove()
        removeMarker(id)
      }
    })

    function clickTitle (element) {
      element = $(element)
      if (!element.find('input').get(0)) {
        element.html('<input value="' + element.html() + '" onkeyup="keypressTitle(this)">')
      }
    }

    function keypressTitle (element) {
      if (event.keyCode === 13) {
        messages.get($(element).parent().parent().attr('id')).put({title: $(element).val()})
      }
    }
    
    function clickCheck (element) {
      console.log("Checked element " + element)
      messages.get($(element).parent().attr('id')).put({done: $(element).prop('checked')})
    }

    function clickDelete (element) {
      console.log("Removed element " + element)
      messages.get($(element).parent().attr('id')).put(null)
    }
  </script>


</body>

</html>